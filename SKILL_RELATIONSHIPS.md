# 技能反制关系说明

## 📋 技能分类

### 1. 进攻型技能
- **飞沙走石** (SKILL_01)
  - 效果：移除对手棋盘上一颗棋子
  - 可被反制：✅ 是 → 擒擒拿拿
  - 可被恢复：✅ 是 → 拾金不昧

### 2. 防御/恢复型技能
- **拾金不昧** (SKILL_02)
  - 效果：恢复被【飞沙走石】移除的棋子
  - 触发条件：有被移除的棋子
  - 可被反制：❌ 否

### 3. 反制型技能
- **擒擒拿拿** (SKILL_03)
  - 效果：阻止【飞沙走石】生效
  - 触发时机：对手使用飞沙走石时弹窗选择
  - 可被反制：❌ 否

### 4. 控制型技能
- **静如止水** (SKILL_04)
  - 效果：使对手本回合+下回合无法行动（冻结2回合）
  - **可被反制：❌ 否** （重要！）
  - 可被解除：✅ 是 → 水滴石穿（被冻结者主动使用）

### 5. 解控型技能
- **水滴石穿** (SKILL_05)
  - 效果：解除【静如止水】的冻结效果
  - **触发条件：自己被冻结时**
  - **使用时机：自己的回合（即使被冻结）**
  - **不是反制技能**：不能在对手使用静如止水时立即反制

### 6. 终结型技能
- **力拔山兮** (SKILL_06)
  - 效果：摔坏棋盘，直接获胜
  - 可被反制：✅ 是 → 两极反转
  - 可被恢复：✅ 是 → 东山再起

### 7. 克制型技能
- **两极反转** (SKILL_07)
  - 效果：阻止【力拔山兮】生效
  - 触发时机：对手使用力拔山兮时弹窗选择
  - 可被反制：❌ 否

### 8. 复活型技能
- **东山再起** (SKILL_08)
  - 效果：恢复被【力拔山兮】摔坏的棋盘
  - 触发条件：棋盘被摔坏
  - 可被反制：❌ 否

---

## 🔗 技能关系链

### 链条1：飞沙走石系列
```
飞沙走石 (主动攻击)
    ├─> 擒擒拿拿 (立即反制) → 技能失效
    └─> 拾金不昧 (事后恢复) → 棋子恢复
```

### 链条2：静如止水系列（重要修复）
```
静如止水 (主动控制)
    └─> 水滴石穿 (被冻结后主动解除)
    
⚠️ 重要说明：
- 静如止水 canBeCountered = false （不能被立即反制）
- 水滴石穿是解控技能，不是反制技能
- 被冻结的玩家可以在自己回合使用水滴石穿解除冻结
- 不能在对手使用静如止水时弹窗反制
```

### 链条3：力拔山兮系列
```
力拔山兮 (主动终结)
    ├─> 两极反转 (立即反制) → 技能失效
    └─> 东山再起 (事后恢复) → 棋盘恢复
```

---

## ⚡ 反制机制说明

### 立即反制（弹窗选择）
当对手使用以下技能时，系统会弹窗询问是否反制：

| 主动技能 | 反制技能 | 反制时机 |
|---------|---------|---------|
| 飞沙走石 | 擒擒拿拿 | 对手确认使用后立即弹窗 |
| 力拔山兮 | 两极反转 | 对手确认使用后立即弹窗 |

**静如止水 ❌ 不在此列**

### 主动解除/恢复
以下技能需要玩家主动使用，不会弹窗：

| 技能 | 前置条件 | 使用时机 |
|------|---------|---------|
| 拾金不昧 | 有被移除的棋子 | 任意己方回合 |
| 水滴石穿 | 自己被冻结 | 被冻结时的己方回合 |
| 东山再起 | 棋盘被摔坏 | 游戏结束后弹窗 |

---

## 🐛 修复说明

### 问题
之前的实现中，静如止水设置了：
```javascript
canBeCountered: true,
counterSkills: [SKILL_ID.WATER_DROP],
```

这导致：
1. 玩家使用静如止水后，AI可以立即反制
2. AI使用静如止水后，玩家可以立即反制
3. 结果可能出现双方互相冻结的情况

### 解决方案
修改为：
```javascript
canBeCountered: false, // 不能被立即反制
```

水滴石穿的正确使用方式：
- 只在自己被冻结时可用（requireCondition: 'FROZEN'）
- 需要玩家主动点击技能卡片使用
- 不会在对手使用静如止水时弹窗

---

## ✅ 技能可用性判断

技能可用性由以下因素决定：

1. **是否已使用** (isUsed)
   - 每个技能每局只能使用一次

2. **前置条件** (requireCondition)
   - PIECE_REMOVED：需要有被移除的棋子（拾金不昧）
   - FROZEN：需要自己被冻结（水滴石穿）
   - BOARD_BROKEN：需要棋盘被摔坏（东山再起）

3. **回合限制**
   - 只能在己方回合使用
   - 被冻结时无法使用技能（水滴石穿除外）

---

## 📝 代码实现要点

### 1. 技能配置 (gameConstants.js)
```javascript
[SKILL_ID.STILL_WATER]: {
  canBeCountered: false, // 关键修复
}

[SKILL_ID.WATER_DROP]: {
  requireCondition: 'FROZEN', // 需要被冻结
}
```

### 2. 技能可用性检查 (useGameState.js)
```javascript
const checkSkillCondition = (skill, state, owner) => {
  switch (skill.requireCondition) {
    case 'FROZEN':
      // 水滴石穿：需要自己被冻结
      return state.effectStates.frozenPlayer === owner;
    // ...
  }
};
```

### 3. 技能效果应用
- 静如止水：冻结对手
- 水滴石穿：解除冻结状态

---

## 🎮 玩家体验

### 正确的游戏流程

1. **对手使用静如止水**
   - 你被冻结2回合
   - **不会**弹出反制窗口
   - 你的技能面板显示冻结状态

2. **被冻结时的操作**
   - 无法落子
   - 无法使用其他技能
   - **可以**点击"水滴石穿"技能卡片
   - 使用水滴石穿后立即解除冻结

3. **技能状态显示**
   - 未被冻结时：水滴石穿显示"置灰 - 需要被静如止水控制"
   - 被冻结时：水滴石穿显示"可用 - 彩色高亮"

---

## 🔍 测试场景

### 场景1：玩家被AI冻结
1. AI使用静如止水
2. 玩家被冻结，无法落子
3. 玩家点击"水滴石穿"技能
4. 冻结解除，玩家可以正常行动

### 场景2：AI被玩家冻结
1. 玩家使用静如止水
2. AI被冻结，自动跳过2个回合
3. AI自动判断是否使用水滴石穿
4. 如果使用，冻结解除

### 场景3：不应出现的情况 ❌
- ❌ 双方同时被冻结
- ❌ 使用静如止水时弹出反制窗口
- ❌ 未被冻结时可以使用水滴石穿

---

## 📚 参考文档

相关文件：
- `/src/constants/gameConstants.js` - 技能配置
- `/src/hooks/useGameState.js` - 技能逻辑
- `/src/components/GameContainer.js` - 游戏流程控制
- `/src/components/SkillCard.js` - 技能卡片UI

设计文档：
- `/.qoder/quests/skill-gomoku-development.md` - 完整设计文档
